=encoding UTF-8

=head1 NAME

OpenTelemetry::SDK::Trace::Span::Processor::Batch - A batched OpenTelemetry span processor

=head1 SYNOPSIS

    ...

=head1 DESCRIPTION

This is a batched span processor that receives read-only
L<OpenTelemetry::Trace::Span> instances and forwards them to an exporter as
readable instances of L<OpenTelemetry::SDK::Trace::Span::Readable>.

This processor is intended to be used in production environments where
performance is important. It will maintain a queue of spans to export, and
periodically exports these in batches in a parallel process, which should
allow the main process to continue executing without any delay added by
exporting the spans.

=head1 METHODS

This class inherits from L<OpenTelemetry::Processor::Batch> and implements
the L<OpenTelemetry::Trace::Span::Processor> role. Please consult
the documentation of those modules for details on the behaviours they provide.
The description below will only refer to those behaviours that differ.

=head2 on_start

    $processor->on_start( $span, $parent_context );

Called when a span is started. In this class, this method does nothing.

=head2 on_end

    $processor->on_end( $span );

Called when a span is ended, with the span that has just ended as its only
parameter. This should be called I<after> the span has been ended.

This method internally passes the span to
L<OpenTelemetry::Processor::Batch/process>.

=head1 METRICS

This processor generates a number of metrics to keep track of its regular
operation. At the time of writing, these metrics are non-standard, but their
inclusion in the standard
L<is being discussed|https://github.com/open-telemetry/semantic-conventions/issues/83>.

=over

=item C<otel.processor.batch.failure>

Incremented every time the span processing failed irrecoverably.

=item C<otel.processor.batch.success>

Incremented every time the span processing completed successfully.

=item C<otel.processor.batch.spans.dropped>

The number of spans that have been dropped and not successfully exported. This
could be because they were never set to the exporter, or because the exporter
reported some error.

Reported with the following attributes:

=over

=item C<reason>

=over

=item C<buffer-full>

The internal queue is full and can receive no more spans.

=item C<export-failure>

The exporter reported an error while exporting the spans.

=item C<force-flush>

The internal queue was flushed and not all queued spans could be exported in
the specified time.

=item C<terminating>

The processor was shutdown and some spans remained in its internal queue.

=back

=back

=item C<otel.processor.batch.spans.processed>

The number of spans successfully processed.

=back

=head1 SEE ALSO

=over

=item L<Future>

=item L<OpenTelemetry::Exporter>

=item L<OpenTelemetry::SDK::Trace::Span::Readable>

=item L<OpenTelemetry::Trace::Span>

=item L<OpenTelemetry::Processor::Batch>

=back

=head1 COPYRIGHT AND LICENSE

This software is copyright (c) 2023 by José Joaquín Atria.

This is free software; you can redistribute it and/or modify it under the same
terms as the Perl 5 programming language system itself.
